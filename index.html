<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sync Card Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  font-family:sans-serif;
  background:#111;
  color:white;
  text-align:center;
  margin:0;
}
h2{margin:10px}
button{
  margin:4px;
  padding:10px;
  font-size:16px;
  border:none;
  border-radius:6px;
}
.card{
  border:1px solid #555;
  padding:6px;
  margin:4px;
  display:inline-block;
  border-radius:6px;
  width:90px;
}
.log{
  max-height:120px;
  overflow:auto;
  border:1px solid #333;
  padding:5px;
  margin:5px;
}
.barWrap{
  background:#400;
  width:90%;
  margin:6px auto;
  border-radius:4px;
}
.bar{
  height:16px;
  background:red;
  width:100%;
  border-radius:4px;
}
</style>
</head>
<body>

<h2>Sync Card Game</h2>

<p>League: <span id="league"></span></p>

<div class="barWrap"><div id="pBar" class="bar"></div></div>
<div class="barWrap"><div id="aBar" class="bar"></div></div>

<p>
HP: <span id="pHP"></span> |
AI: <span id="aHP"></span> |
Sync: <span id="sync"></span>
</p>

<p>
Wins: <span id="wins"></span> |
Losses: <span id="losses"></span> |
Rating: <span id="rating"></span>
</p>

<button onclick="openPack()">パック開封</button>
<button onclick="showCollection()">コレクション</button>
<button onclick="showDeckBuilder()">デッキ編集</button>
<button onclick="resetBattle()">リセット</button>

<h3>手札</h3>
<div id="hand"></div>

<h3>バトルログ</h3>
<div id="log" class="log"></div>

<script>
// ===== 状態 =====
let playerHP=20;
let aiHP=20;
let simultaneousCount=0;
let globalSerial=1;

let deck=[];
let hand=[];
let collection=[];
let league="Bronze";

let stats={wins:0,losses:0,rating:1000};

let maxDeckSize=20;

// ===== カードプール =====
const cardPool=[
 {name:"フレア",damage:2,rarity:"Common"},
 {name:"ヒール",heal:3,rarity:"Common"},
 {name:"量子斬撃",damage:4,rarity:"Uncommon"},
 {name:"爆炎同期",damage:3,syncBonus:2,rarity:"Rare"},
 {name:"星核崩壊",damage:6,rarity:"Epic"},
 {name:"Ω-CORE",damage:10,rarity:"Legend"}
];

const promoPool=[
 {name:"プロトΩ",damage:12,rarity:"Mythic"},
 {name:"創世神コード",damage:20,rarity:"Godly"}
];

// ===== 保存 =====
function saveGame(){
 localStorage.setItem("syncSave",JSON.stringify({
  playerHP,aiHP,simultaneousCount,
  globalSerial,deck,hand,collection,
  stats,league
 }));
}

function loadGame(){
 const d=JSON.parse(localStorage.getItem("syncSave"));
 if(!d) return;
 Object.assign(window,d);
}

// ===== 初期化 =====
function init(){
 loadGame();
 if(deck.length===0){
  for(let i=0;i<10;i++) addCard(cardPool[0]);
  shuffle(deck);
  draw(5);
 }
 updateUI();
}
function resetBattle(){
 setLeague(league);
 playerHP=20;
 simultaneousCount=0;
 hand=[];
 shuffle(deck);
 draw(5);
 log("=== 新バトル ===");
 saveGame();
 updateUI();
}

// ===== デッキ追加 =====
function addCard(base){
 let c=JSON.parse(JSON.stringify(base));
 c.serial=globalSerial++;
 deck.push(c);
 collection.push(c);
}

// ===== パック =====
function rollRarity(){
 let r=Math.random();
 if(r<0.5)return"Common";
 if(r<0.75)return"Uncommon";
 if(r<0.9)return"Rare";
 if(r<0.98)return"Epic";
 return"Legend";
}

function openPack(){
 for(let i=0;i<3;i++){
  let rarity=rollRarity();
  let list=cardPool.filter(c=>c.rarity===rarity);
  addCard(list[Math.floor(Math.random()*list.length)]);
 }
 alert("3枚入手！");
 saveGame();
}

// ===== デッキ編集 =====
function showDeckBuilder(){
 let text=collection.map((c,i)=>
  i+" : "+c.name+" #"+c.serial
 ).join("\n");
 let n=prompt("番号入力\n"+text);
 if(n===null) return;
 let card=collection[n];
 if(!card)return;
 if(deck.length>=maxDeckSize){
  alert("20枚まで");
  return;
 }
 deck.push(card);
 alert("追加！");
 saveGame();
}

// ===== ドロー =====
function shuffle(a){
 for(let i=a.length-1;i>0;i--){
  let j=Math.floor(Math.random()*(i+1));
  [a[i],a[j]]=[a[j],a[i]];
 }
}
function draw(n){
 for(let i=0;i<n;i++){
  if(deck.length>0) hand.push(deck.pop());
 }
 renderHand();
}

// ===== 表示 =====
function renderHand(){
 let div=document.getElementById("hand");
 div.innerHTML="";
 hand.forEach((c,i)=>{
  let d=document.createElement("div");
  d.className="card";
  d.innerHTML=c.name+"<br>#"+c.serial+"<br>"+c.rarity;
  d.onclick=()=>playCard(i);
  div.appendChild(d);
 });
}

// ===== AI =====
function randomAICard(){
 return cardPool[Math.floor(Math.random()*cardPool.length)];
}

function setLeague(l){
 league=l;
 if(l==="Bronze") aiHP=20;
 if(l==="Silver") aiHP=25;
 if(l==="Gold") aiHP=30;
 if(l==="Mythic") aiHP=40;
}

// ===== プレイ =====
function playCard(i){
 let p=hand.splice(i,1)[0];
 let a=randomAICard();

 let sync=(p.damage&&a.damage);
 if(sync&&simultaneousCount<2) simultaneousCount++;

 resolve(p,a,sync);
 draw(1);
 saveGame();
}

function resolve(p,a,sync){
 let pD=p.damage||0;
 let aD=a.damage||0;

 if(sync&&p.syncBonus)pD+=p.syncBonus;

 if(league==="Silver")aD+=1;
 if(league==="Gold")aD+=2;
 if(league==="Mythic")aD+=3;

 aiHP-=pD;
 playerHP-=aD;

 if(p.heal)playerHP+=p.heal;
 if(a.heal)aiHP+=a.heal;

 log("P:"+p.name+" / AI:"+a.name);
 checkWin();
 updateUI();
}

function checkWin(){
 if(playerHP<=0||aiHP<=0){
  if(playerHP>aiHP){
   stats.wins++;
   stats.rating+=10;
   log("勝利！");
   promoCheck();
  }else{
   stats.losses++;
   stats.rating-=5;
   log("敗北...");
  }
  unlockLeague();
  saveGame();
 }
}

// ===== プロモ =====
function promoCheck(){
 if(Math.random()<0.05){
  let c=JSON.parse(JSON.stringify(promoPool[0]));
  c.serial=globalSerial++;
  collection.push(c);
  alert("プロモ入手！");
 }
 if(Math.random()<0.005){
  let g=JSON.parse(JSON.stringify(promoPool[1]));
  g.serial=globalSerial++;
  collection.push(g);
  alert("GODLY入手！！");
 }
}

// ===== リーグ解放 =====
function unlockLeague(){
 if(stats.wins>30) league="Mythic";
 else if(stats.wins>15) league="Gold";
 else if(stats.wins>5) league="Silver";
 else league="Bronze";
 setLeague(league);
}

// ===== コレクション =====
function showCollection(){
 alert(collection.map(c=>c.name+" #"+c.serial+" "+c.rarity).join("\n"));
}

// ===== UI =====
function updateUI(){
 pHP.textContent=playerHP;
 aHP.textContent=aiHP;
 sync.textContent=simultaneousCount;
 wins.textContent=stats.wins;
 losses.textContent=stats.losses;
 rating.textContent=stats.rating;
 league.textContent=league;

 pBar.style.width=(playerHP/40*100)+"%";
 aBar.style.width=(aiHP/40*100)+"%";
}

function log(t){
 document.getElementById("log").innerHTML=
  t+"<br>"+document.getElementById("log").innerHTML;
}

init();
</script>

</body>
</html>
